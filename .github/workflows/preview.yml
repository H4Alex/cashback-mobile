name: Preview Build

on:
  pull_request:
    branches: [main]
    types: [labeled]

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  preview:
    name: Build Preview (EAS)
    if: github.event.label.name == 'preview-build'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Verificar EXPO_TOKEN
        id: check-token
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "has_token=false" >> "$GITHUB_OUTPUT"
            echo "::warning::EXPO_TOKEN nao configurado â€” pulando preview build"
          else
            echo "has_token=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout do repositorio
        if: steps.check-token.outputs.has_token == 'true'
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: steps.check-token.outputs.has_token == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Expo CLI
        if: steps.check-token.outputs.has_token == 'true'
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Instalar dependencias
        if: steps.check-token.outputs.has_token == 'true'
        run: npm ci

      - name: Publicar preview update
        if: steps.check-token.outputs.has_token == 'true'
        id: update
        run: |
          BRANCH="pr-${{ github.event.pull_request.number }}"
          OUTPUT=$(eas update --branch "$BRANCH" --message "PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}" --non-interactive --json 2>&1)
          echo "$OUTPUT"

          UPDATE_GROUP=$(echo "$OUTPUT" | jq -r '.[0].group // empty' 2>/dev/null || true)
          echo "update_group=$UPDATE_GROUP" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Comentar na PR
        if: steps.check-token.outputs.has_token == 'true' && steps.update.outputs.update_group != ''
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.update.outputs.branch }}';
            const group = '${{ steps.update.outputs.update_group }}';
            const projectId = '89aa8fa1-4ffa-4d64-aa1b-eb399aa3e07b';

            const body = [
              '## ðŸ“± Preview Build Disponivel',
              '',
              `**Branch:** \`${branch}\``,
              `**Update Group:** \`${group}\``,
              '',
              `**QR Code:** [Abrir no Expo Go](https://u.expo.dev/update/${group})`,
              '',
              '> Para testar, abra o Expo Go e escaneie o QR code acima.',
              '> Ou use um development build apontando para a branch `' + branch + '`.',
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
